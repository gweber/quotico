# ðŸ”¬ Technical Debt Report â€” Quotico â€žClean-Sweep" Audit

**Datum:** 2026-02-27  
**Scope:** Gesamte Codebasis (Backend + Frontend)  
**Kontext:** Post-Sportmonks v3 Migration (Integer-IDs)

---

## ðŸ”´ KRITISCH â€” Sofort fixen (Datenkorruption / Typ-Fehler-Risiko)

### K1. Zwei-Klassen-Gesellschaft: Duale Collection-Architektur
**Schweregrad: ðŸ”´ðŸ”´ðŸ”´**

Das System betreibt **parallel** zwei vollstÃ¤ndige Match/Team/League-Welten:

| Legacy Collections | v3 Collections |
|---|---|
| `db.matches` (ObjectId, ~135 Referenzen) | `db.matches_v3` (int, ~79 Referenzen) |
| `db.teams` (ObjectId, ~40 Referenzen) | `db.teams_v3` (int) |
| `db.leagues` (ObjectId, ~25 Referenzen) | `db.league_registry_v3` (int) |

**Betroffene Kernservices auf Legacy:**
- `match_service.py` â€” gesamte Match-Logik auf `db.matches`
- `odds_service.py` â€” Odds-Ingest schreibt in `db.matches`
- `match_ingest_service.py` â€” Ingest schreibt in `db.matches`
- `quotico_tip_service.py` â€” Q-Tip-Berechnung liest aus `db.matches`
- `optimizer_service.py` â€” Calibration liest aus `db.matches`
- `team_registry_service.py` â€” gesamte Team-Registry auf `db.teams`
- `admin_service.py` â€” Team-Merge/Match-Dedupe auf `db.matches`+`db.teams`
- **Alle Worker** (`match_resolver`, `matchday_sync`, `quotico_tip_worker`, `bankroll_resolver`, etc.) â€” lesen/schreiben in `db.matches`

**Risiko:** Daten werden in beide Welten geschrieben. Ein Match existiert mÃ¶glicherweise in `matches` UND `matches_v3` mit unterschiedlichen ZustÃ¤nden. Q-Tips und Calibration nutzen die Legacy-Welt, wÃ¤hrend der User im Frontend v3-Daten sieht.

### K2. ObjectId auf Legacy-Matches fÃ¼r Sportmonks-EntitÃ¤ten
**Schweregrad: ðŸ”´ðŸ”´**

17 Stellen nutzen `ObjectId(match_id)` auf Legacy-Collections. Wenn ein Sportmonks Integer-ID versehentlich als ObjectId interpretiert wird, crasht der Service.

**Hotspots:**
- `betting_slip_service.py:37` â€” `int(match_id)` fÃ¼r v3, aber `ObjectId(match_id)` fÃ¼r Legacy
- `survivor_service.py` â€” mischt `ObjectId(match_id)` und `int(match_id)` im gleichen Service
- `war_room_service.py` â€” versucht beides: erst v3 `int()`, dann Legacy `ObjectId()`

### K3. `_toLegacyMatch()` Shim im Frontend
**Schweregrad: ðŸ”´ðŸ”´**

`frontend/src/stores/matches.ts` empfÃ¤ngt v3-Daten und konvertiert sie in ein Legacy-Format. Dabei gehen v3-spezifische Daten verloren oder werden falsch gemappt (z.B. `season_id` â†’ `season`). Die `Match.ts` Interface-Definition ist ein Hybrid-Monster mit Legacy- UND v3-Feldern.

---

## ðŸŸ  LEGACY â€” LÃ¶schen / Migrieren

### L1. TheOddsAPI Provider â€” Gesamter Legacy-Ingest-Pfad
**25 Referenzen** auf `theoddsapi` / `odds_api` / `TheOddsAPIProvider`

Seit Sportmonks v3 die Odds-Quelle ist, ist der gesamte TheOddsAPI-Pfad obsolet:
- `backend/app/providers/odds_api.py` â€” Gesamte Provider-Klasse
- `backend/app/services/odds_service.py` â€” Nutzt `TheOddsAPIProvider`
- `backend/app/services/match_service.py` â€” `sync_matches_for_sport()` Ã¼ber TheOddsAPI
- `backend/app/workers/match_resolver.py` â€” `_resolve_via_theoddsapi()` Funktion
- `backend/app/routers/matches.py` â€” `/admin/odds/sync` und `/admin/matches/{id}/refresh-odds`

### L2. Legacy Router `matches.py`
Der Router dokumentiert sich selbst als Legacy: *"The v3 query layer (v3_query.py) is the modern replacement"*. Endpunkte:
- `GET /api/matches` â€” wird von `AdminMatchesView.vue` aufgerufen
- `GET /api/matches/{match_id}` â€” Legacy ObjectId lookup
- `GET /api/matches/live` / `live-candidates`
- `POST /admin/odds/sync` â€” TheOddsAPI
- `POST /admin/matches/{id}/recalc-tip`
- `POST /admin/matches/{id}/refresh-odds` â€” TheOddsAPI

### L3. Legacy Router `historical.py`
EnthÃ¤lt:
- `POST /admin/historical/import-matches` â€” nutzt `sync_matches_for_sport()` (TheOddsAPI)
- `POST /admin/historical/migrate-aliases` â€” One-time Migration auf `db.teams`
- Calibration/Reliability triggers (diese sind noch aktiv, sollten aber in `admin_ingest.py` konsolidiert werden)

### L4. Legacy Router `teams.py`
Operiert auf `db.teams` (ObjectId-basiert). Ersetzt durch `admin_teams_v3.py`.

### L5. `SUPPORTED_SPORTS` Vierfach-Duplikat
Hardcodierte String-Listen in **4+ Dateien**:
- `backend/app/models/matches.py`
- `backend/app/services/match_service.py`
- `backend/app/services/odds_service.py`
- `backend/app/workers/match_resolver.py`

Plus weitere hardcodierte Listen:
- `CALIBRATED_LEAGUES` in `optimizer_service.py`
- `RELATED_SPORT_KEYS` in `historical_service.py`
- `CORE_LEAGUES` in `league_seed_service.py`
- `MATCHDAY_V3_SPORTS` in `config_matchday.py`

**Alle diese sollten aus `league_registry_v3` dynamisch geladen werden.**

### L6. Legacy-Modelle
- `backend/app/models/match.py` â€” Legacy Match-Model
- `backend/app/models/matches.py` â€” SUPPORTED_SPORTS + Legacy-Constants
- `backend/app/models/teams.py` â€” Legacy Team-Model
- `backend/app/models/leagues.py` â€” Legacy League-Model
- Existieren parallel zu `backend/app/models/v3_models.py` und `v3_query_models.py`

### L7. `sport_key` als PrimÃ¤rschlÃ¼ssel
**300+ Backend-Referenzen, 73 Frontend-Referenzen**

`sport_key` (z.B. `"soccer_germany_bundesliga"`) ist das Legacy-Identifikationssystem fÃ¼r Ligen. Im v3-System ist die Sportmonks `league_id` (Integer) der PrimÃ¤rschlÃ¼ssel. `sport_key` wird noch verwendet von:
- Allen Legacy-Services und Workers
- `engine_config` Collection (Key = `sport_key`)
- Calibration, Reliability, Q-Tip Services
- Frontend Navigation, Stores, Route-Parameter
- `league_registry_v3` hat zwar ein `sport_key`-Feld, aber es ist ein optionales Mapping, nicht der Primary Key

### L8. Frontend Legacy-Patterns
- `AdminMatchesView.vue` â€” ruft `/api/matches` auf (Legacy-Endpunkt)
- `AdminDashboard.vue` â€” zeigt `sport_key`-Strings mit hardcodierten Flag-Mappings
- `AdminTeamDetail.vue` â€” zeigt `sport_key` aus Legacy-Teams
- `frontend/src/types/sports.ts` â€” hardcodierte Sport-Konfiguration statt API-basiert

### L9. Dangling Provider-Code
- `backend/app/providers/football_data.py` â€” football-data.org Provider
- `backend/app/providers/openligadb.py` â€” OpenLigaDB Provider
- `backend/app/providers/football_data_uk.py` â€” football-data.co.uk Provider
- Diese werden noch fÃ¼r historische Imports genutzt, aber der primÃ¤re Ingest lÃ¤uft Ã¼ber Sportmonks

### L10. Frontend `any`-Casts
43 `any`-Type-Casts in Vue/TS-Dateien. Hotspots:
- `QuoticoTipBadge.vue` â€” 7 Casts fÃ¼r `tier_signals` Sub-Objekte
- `MatchdayMatchCard.vue` â€” 5 Casts fÃ¼r `match.result`
- `BankrollBetCard.vue`, `SurvivorPickCard.vue`, `FantasyPickCard.vue` â€” Score-Display `as any`
- `AdminQbotStrategyDetailView.vue` â€” Chart-Daten Casts

---

## ðŸ”µ ARCHITEKTUR-VORSCHLAG

### A1. â€žGreat Unification" â€” Eliminate Dual Collections
**Phase 1:** Alle Services, die auf `db.matches` lesen, auf `db.matches_v3` umstellen:
1. `quotico_tip_service.py` â†’ v3
2. `optimizer_service.py` â†’ v3
3. `odds_service.py` â†’ v3 (Odds-Ingest Ã¼ber Sportmonks Connector)
4. `match_service.py` â†’ v3 oder eliminieren
5. Alle Worker (`match_resolver`, `matchday_sync`, etc.) â†’ v3

**Phase 2:** Legacy-Collections `matches`, `teams`, `leagues` auf read-only setzen, dann lÃ¶schen.

**Phase 3:** `_v3` Suffix entfernen â€” die v3-Collections werden zu den einzigen Collections.

### A2. Sport-Key Deprecation
1. Zentrales `LeagueRegistry` als **einzige** Source fÃ¼r Liga-Konfiguration
2. `SUPPORTED_SPORTS`, `CALIBRATED_LEAGUES`, `RELATED_SPORT_KEYS` â†’ dynamisch aus `league_registry_v3` laden
3. Engine-Config Key von `sport_key` auf `league_id` (int) umstellen
4. Frontend-Navigation auf `league_id` umstellen, `sport_key` nur noch als Display-Label

### A3. TheOddsAPI Entfernung
1. `providers/odds_api.py` lÃ¶schen
2. Alle `sync_matches_for_sport()` Aufrufe entfernen
3. `match_service.py` auf reine v3-Logik reduzieren oder eliminieren
4. Match-Resolver von TheOddsAPI-Score-Polling auf Sportmonks umstellen

### A4. Frontend Type Safety
1. `Match.ts` auf reine v3-Felder reduzieren
2. `_toLegacyMatch()` Shim eliminieren
3. Alle `as any` Casts durch proper Interfaces ersetzen
4. `sports.ts` durch API-basiertes League-Fetching ersetzen

### A5. Router-Konsolidierung
| LÃ¶schen | Behalten / Migrieren |
|---|---|
| `matches.py` | `v3_query.py` (wird zum neuen `matches.py`) |
| `teams.py` | `admin_teams_v3.py` |
| `historical.py` (teilweise) | Calibration/Reliability Endpunkte â†’ `admin_ingest.py` |

---

## Zusammenfassung

| Kategorie | Befunde | Schwere |
|---|---|---|
| Duale Collections | 135 Legacy + 79 v3 Refs | ðŸ”´ Kritisch |
| sport_key AbhÃ¤ngigkeit | 300+ Backend, 73 Frontend | ðŸŸ  Legacy |
| SUPPORTED_SPORTS Duplikation | 4+ Kopien | ðŸŸ  Legacy |
| TheOddsAPI Code | 25 Refs, komplett obsolet | ðŸŸ  Legacy |
| Frontend `any` Casts | 43 Stellen | ðŸŸ¡ QualitÃ¤t |
| `datetime.now()` Violations | 0 | âœ… Clean |
| `team_key` Violations | 0 | âœ… Clean |

**Empfohlene Reihenfolge:**
1. K1/K2 â€” Duale Collections auflÃ¶sen (hÃ¶chstes Korruptionsrisiko)
2. L1/L2/L3 â€” TheOddsAPI + Legacy-Router lÃ¶schen (grÃ¶ÃŸte Code-Masse)
3. L5 â€” SUPPORTED_SPORTS zentralisieren (Konsistenz)
4. A2 â€” sport_key Deprecation (architektonisch)
5. A4 â€” Frontend Type Safety (QualitÃ¤t)

Soll ich mit der Umsetzung eines bestimmten Blocks beginnen? Dann bitte zu **Act Mode** wechseln.